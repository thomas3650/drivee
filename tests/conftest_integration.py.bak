"""Fixtures for Drivee tests."""

from __future__ import annotations

import sys
from collections.abc import Generator
from pathlib import Path
from unittest.mock import AsyncMock, MagicMock

import pytest

# Add parent directory to path for imports
sys.path.insert(0, str(Path(__file__).parent.parent))

# Check if Home Assistant is available
try:
    import homeassistant  # noqa: F401
    HAS_HA = True
except (ImportError, ModuleNotFoundError):
    HAS_HA = False

# Skip all fixtures in this file if HA is not available
pytestmark = pytest.mark.skipif(not HAS_HA, reason="Home Assistant not available")


@pytest.fixture
def mock_drivee_client() -> Generator[MagicMock]:
    """Mock DriveeClient."""
    mock_client = MagicMock()
    mock_client.authenticate = AsyncMock()
    mock_client.get_charge_point = AsyncMock()
    mock_client.get_charging_history = AsyncMock()
    mock_client.get_price_periods = AsyncMock()
    mock_client.start_charging = AsyncMock()
    mock_client.end_charging = AsyncMock()
    mock_client.close = AsyncMock()
    mock_client.__aenter__ = AsyncMock(return_value=mock_client)
    mock_client.__aexit__ = AsyncMock()
    yield mock_client


@pytest.fixture
def mock_charge_point() -> MagicMock:
    """Create a mock ChargePoint."""
    evse_session = MagicMock()
    evse_session.id = "session_123"
    evse_session.start_time = "2026-01-30T10:00:00Z"
    evse_session.energy_wh = 5000

    evse = MagicMock()
    evse.is_charging = False
    evse.is_charging_session_active = False
    evse.is_connected = True
    evse.session = evse_session
    evse.status.value = "Available"

    charge_point = MagicMock()
    charge_point.id = "charger_1"
    charge_point.name = "Test Charger"
    charge_point.evse = evse

    return charge_point


@pytest.fixture
def mock_charging_history() -> MagicMock:
    """Create a mock ChargingHistory."""
    session = MagicMock()
    session.id = "session_123"
    session.start_time = "2026-01-30T10:00:00Z"
    session.end_time = "2026-01-30T11:00:00Z"
    session.energy_wh = 10000
    session.energy = 10000
    session.cost = 25.50

    history = MagicMock()
    history.sessions = [session]
    history.last_session = session

    return history


@pytest.fixture
def mock_price_periods() -> MagicMock:
    """Create a mock PricePeriods."""
    period = MagicMock()
    period.start_time = "2026-01-30T12:00:00Z"
    period.end_time = "2026-01-30T12:15:00Z"
    period.price_kr = 2.50
    period.price_per_kwh = 2.50

    price_periods = MagicMock()
    price_periods.periods = [period]
    price_periods.get_price_at = MagicMock(return_value=period)

    return price_periods


@pytest.fixture
def mock_config_entry_data() -> dict[str, str]:
    """Create mock config entry data."""
    return {
        "username": "test@example.com",
        "password": "test_password",
    }
